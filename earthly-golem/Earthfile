#
# Generated by @zondax/cli
#
VERSION 0.7
FROM golang:1.20-alpine
ARG --global BASE_NAME=znats

RUN apk update \
    && apk --no-cache --update add build-base bash git

# Let's unify on a common place
WORKDIR /app

build-base:
    DO ../+GET_SOURCE_CODE
    RUN make build
    SAVE ARTIFACT /app

build-production:
    # TODO: Move this to a base image that we use everywhere?
    FROM alpine:3.17

    RUN apk update \
    && apk --no-cache --update add ca-certificates

    COPY ./zondax_CA.crt /usr/local/share/ca-certificates/zondax_CA.crt
    RUN update-ca-certificates

    RUN addgroup --system --gid 1001 zondax
    RUN adduser --system --uid 1001 zondax
    USER zondax

    # This could be optimized. Keeping it simple for now
    COPY --chown=zondax:zondax +build-base/app/output /zondax/bin

    EXPOSE 9090

    # TODO: can we ensure that we always have k8s probes?
    CMD ["/zondax/bin/znats", "start", "-c", "/zondax/config/znats.yaml"]

    DO ../+PUBLISH_WITH_FLEXTAGS --CONTAINER_FULLNAME=${BASE_NAME}

all:
    BUILD +build-production
